import{x as e,Q as a,o as t,c as s,w as i,a as o,f as l,g as n,l as c,i as d,R as r,t as u,k as m,I as h,S as p,T as g,r as f,e as b,y,z as M,n as v}from"./index-BR_epvkd.js";import{i as k,s as I}from"./captcha.l4zB_yAz.js";import{i as S,a as C}from"./verify.Dz7mnHVd.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{i as N}from"./upload.g1lSbLaT.js";import{A as x}from"./index.DuUwd-w6.js";const R={props:{isParty:{type:Boolean,default:()=>!1},partyData:{type:Object}},data:()=>({code:""}),methods:{async clickPhoneNumber(){this.code=await this.getCode()},async handelMpWeixinMobileLogin({detail:a}){const t=this;"getPhoneNumber:ok"==a.errMsg?"getPhoneNumber:ok"==a.errMsg&&(t.isLoading=!0,e.dispatch("LoginMpWxMobile",{code:t.code,encryptedData:a.encryptedData,iv:a.iv,isParty:t.isParty,partyData:t.partyData}).then((e=>{t.$toast(e.message),uni.$emit("syncRefresh",!0),setTimeout((()=>t.onNavigateBack(1)),2e3)})).catch((e=>{e.result.data})).finally((()=>t.isLoading=!1))):console.log("微信授权获取手机号失败",a)},getCode:()=>new Promise(((e,a)=>{uni.login({provider:"weixin",success:a=>{console.log("code",a.code),e(a.code)},fail:a})})),onNavigateBack(e=1){a().length>1?uni.navigateBack({delta:Number(e||1)}):this.$navTo("pages/index/index")}}};const B=A({components:{Main:A({components:{MpWeixinMobile:A(R,[["render",function(e,a,u,m,h,p){const g=n,f=c,b=d,y=r;return t(),s(b,{class:"wechat-auth"},{default:i((()=>[o(y,{class:"btn-normal","open-type":"getPhoneNumber",onGetphonenumber:a[0]||(a[0]=e=>p.handelMpWeixinMobileLogin(e)),onClick:p.clickPhoneNumber},{default:i((()=>[o(b,{class:"wechat-auth-container"},{default:i((()=>[o(g,{class:"icon",src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACIAAAAiCAYAAAA6RwvCAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5ODg0MTRBQTNDNDkxMUVCQTc3QkEyRERBRTQxMDdERCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5ODg0MTRBQjNDNDkxMUVCQTc3QkEyRERBRTQxMDdERCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjk4ODQxNEE4M0M0OTExRUJBNzdCQTJEREFFNDEwN0REIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjk4ODQxNEE5M0M0OTExRUJBNzdCQTJEREFFNDEwN0REIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+S3My7wAABHpJREFUeNq8mGuIVVUUx9c+d0bHV1rZVPMhZqCwl070UNOQJCsSK6X8EKRUlKAUUh/qS9GHgiACQSKSiCEqI6oPEtUH0VJyHjVQ6mg+UBErcpjGxkeNM3PP6bfX2ffcM87Z99557uG/97777L3W/6y91t7rjJFW8Rfj2sjBSEC9AswBd4JbQB2w453gCGgDvzF/J223PpGUHK+qckQsQmmg3ggeBfVSWekB21j/Pm3LaIlMoX4LAc/T5mTk5QtkvYSc330TghKLF7HwANg4ShK2rEbOUdq1wyWyGuwBDTJ2pQZ8BF7LepiTZ4eMrQJfyviVpep1IrsHe0HLoAi5DfwiE1OeAU0FBzbyU8o6oZymvVImqhgi0MhJ261KnRWbKiTxB+gCA+AycMMoqHyO/oUxpzYlcS31n2UWfQy2MLcV5DWO4kOugfY5euvBrBFY5QHq7bGPGNlM/YJn4gXwCKp3aoyFjkCRSMGitfQ/ob1/mFSaWbPYEpmEgFMM1GaQiFDeSLtfNyLgaA/lL0Z7EgI2xHNsVSDn5KISamHDF5Y6RYeUSG4K3BvUZk7Iy5vSB4lQSdzL70MQ+Cw53iJZAI6DryT2OJFqWcb888O0yoMBCuZ5HoYoeC859gw+ZOR7et/q2w4okU7GvqbdgjVquBBul2kyHcIdw/STe+xdYw+vxzIet0PlLlVa7cgMOB8pnJOhGxN5GCxnbgfjbbpFoczFco8ztrwCKoesMRs9D88NSgMk5ZyzHHrwry55mS0JGX8dS3Qq4UiJtDPexO+5jDcxckcJIjOtRc54wu4iQupQ0J3kI6GzzjTX75OngX3/ramcJZbW5xKBScmLtJcg0xOkAvDSMhllr6rp86ktsf2zivnyr1yDkq1O0YcaZf14SqhSN4kNhQFeJia4KiVliJdYIv+UMNmLLF2S3EV2dj84r+1VelPlk1fZC77BAqH00uuVX/GRbTIb29SofU9BaLtHT2+gaV2pkpNdKHoy8ROTbNNpnp1IZSqbNY3MobJK59krfyV27UpC28hhj5azgcsxyx04C5wPzEPgdTJDN66G31dnBH3RV3JuG3uT1Op6j4YjlsjBMjS6EdrMtryr5o+4LSNaQyQYwvbS1KpatyHeQkvqv+LpSf2Q5xz50aq4HGE2l5zqIWI9YkpmuhihMoeVIrL3QtRMdRbIp5LvfuwYkCpWce1HmRa/O2DiGXUyf5nuzVmNRtYeBN2Xmf0Xzp5q2YeEes/9Yz9BWgtpwFhkZt+BH4iaNiwQ8jdfLRnIO5A6xu86z7qnbC5r5OfEyeydsWLUWVc05GQ66Lzl1gyLnoRofTFVjEPyCqb/LRNZjCzWQNAjKkwus27qJyaQxtu8fLPqDwufE0VTdjgzLh1nEp+CDeW+a3aPMxmb+66p9EvvDbBuXLbD89lZ6tv3A7bsZrBjDAjsR84y2ldG8hEueiHGAlaWOfR8pZX1G4BNR3eUDqBK/1ETl0b6SxhfRP9GMBvMcDMvABv+J5izSxMhozd3Rf+o+V+AAQAKQEmumQtkwAAAAABJRU5ErkJggg=="}),o(f,{class:"title"},{default:i((()=>[l("手机号快捷登录")])),_:1})])),_:1})])),_:1},8,["onClick"])])),_:1})}],["__scopeId","data-v-e68dce36"]])},props:{isParty:{type:Boolean,default:()=>!1},partyData:{type:Object},isMpWeixinMobile:{type:Boolean,default:()=>!1}},data:()=>({isLoading:!1,disabled:!1,captcha:{},smsState:!1,times:60,mobile:"",captchaCode:"",smsCode:""}),created(){this.getCaptcha()},methods:{getCaptcha(){const e=this;k().then((a=>e.captcha=a.data))},handelSmsCaptcha(){const e=this;e.isLoading||e.smsState||!e.formValidation(10)||e.sendSmsCaptcha()},formValidation(e=10){const a=this;return!!(10!==e||a.validteMobile(a.mobile)&&a.validteCaptchaCode(a.captchaCode))&&!!(20!==e||a.validteMobile(a.mobile)&&a.validteSmsCode(a.smsCode))},validteMobile(e){return S(e)?(this.$toast("请先输入手机号"),!1):!!C(e)||(this.$toast("请输入正确格式的手机号"),!1)},validteCaptchaCode(e){return!S(e)||(this.$toast("请先输入图形验证码"),!1)},validteSmsCode(e){return!S(e)||(this.$toast("请先输入短信验证码"),!1)},sendSmsCaptcha(){const e=this;e.isLoading=!0,I({form:{captchaKey:e.captcha.key,captchaCode:e.captchaCode,mobile:e.mobile}}).then((a=>{e.$toast(a.message),e.timer()})).catch((()=>e.getCaptcha())).finally((()=>e.isLoading=!1))},timer(){const e=this;e.smsState=!0;const a=setInterval((()=>{e.times=e.times-1,e.times<=0&&(e.smsState=!1,e.times=60,clearInterval(a))}),1e3)},handleLogin(){const e=this;e.isLoading||e.disabled||!e.formValidation(20)||e.submitLogin()},submitLogin(){const a=this;a.isLoading=!0,a.disabled=!0,e.dispatch("Login",{smsCode:a.smsCode,mobile:a.mobile,isParty:a.isParty,partyData:a.partyData}).then((e=>{a.$toast(e.message),uni.$emit("syncRefresh",!0),setTimeout((()=>a.onNavigateBack(1)),2e3)})).catch((e=>{a.disabled=!1})).finally((()=>a.isLoading=!1))},onNavigateBack(e=1){a().length>1?uni.navigateBack({delta:Number(e||1)}):this.$navTo("pages/index/index")}}},[["render",function(e,a,r,p,g,f){const b=c,y=d,M=h,v=n;return t(),s(y,{class:"container"},{default:i((()=>[o(y,{class:"header"},{default:i((()=>[o(y,{class:"title"},{default:i((()=>[o(b,null,{default:i((()=>[l("手机号登录")])),_:1})])),_:1}),o(y,{class:"sub-title"},{default:i((()=>[o(b,null,{default:i((()=>[l("未注册的手机号登录后将自动注册")])),_:1})])),_:1})])),_:1}),o(y,{class:"login-form"},{default:i((()=>[o(y,{class:"form-item"},{default:i((()=>[o(M,{class:"form-item--input",type:"number",modelValue:g.mobile,"onUpdate:modelValue":a[0]||(a[0]=e=>g.mobile=e),maxlength:"11",placeholder:"请输入手机号码"},null,8,["modelValue"])])),_:1}),o(y,{class:"form-item"},{default:i((()=>[o(M,{class:"form-item--input",type:"text",modelValue:g.captchaCode,"onUpdate:modelValue":a[1]||(a[1]=e=>g.captchaCode=e),maxlength:"5",placeholder:"请输入图形验证码"},null,8,["modelValue"]),o(y,{class:"form-item--parts"},{default:i((()=>[o(y,{class:"captcha",onClick:a[2]||(a[2]=e=>f.getCaptcha())},{default:i((()=>[o(v,{class:"image",src:g.captcha.base64},null,8,["src"])])),_:1})])),_:1})])),_:1}),o(y,{class:"form-item"},{default:i((()=>[o(M,{class:"form-item--input",type:"number",modelValue:g.smsCode,"onUpdate:modelValue":a[3]||(a[3]=e=>g.smsCode=e),maxlength:"6",placeholder:"请输入短信验证码"},null,8,["modelValue"]),o(y,{class:"form-item--parts"},{default:i((()=>[o(y,{class:"captcha-sms",onClick:a[4]||(a[4]=e=>f.handelSmsCaptcha())},{default:i((()=>[g.smsState?(t(),s(b,{key:1,class:"un-activate"},{default:i((()=>[l("重新发送("+u(g.times)+")秒",1)])),_:1})):(t(),s(b,{key:0,class:"activate"},{default:i((()=>[l("获取验证码")])),_:1}))])),_:1})])),_:1})])),_:1}),o(y,{class:m(["login-button",{disabled:g.disabled}]),onClick:a[5]||(a[5]=e=>f.handleLogin())},{default:i((()=>[o(b,null,{default:i((()=>[l("登录")])),_:1})])),_:1},8,["class"])])),_:1})])),_:1})}],["__scopeId","data-v-ae9883c9"]]),MpWeixin:A({components:{AvatarImage:x},data:()=>({storeInfo:void 0,isPersonal:void 0,code:"",disabled:!1,avatarUrl:"",tempFile:void 0,form:{avatarId:null,nickName:""}}),created(){this.getStoreInfo(),this.getIsPersonal()},methods:{getStoreInfo(){p.storeInfo().then((e=>this.storeInfo=e))},async getIsPersonal(){const e=this;g({code:await e.getCode()}).then((a=>e.isPersonal=a.data.isPersonalMpweixin))},getCode:()=>new Promise(((e,a)=>{uni.login({provider:"weixin",success({code:a}){console.log("code",a),e(a)},fail:a})})),onInputNickName({detail:e}){console.log(e),e.value&&(this.form.nickName=e.value)},onClickAvatar(){this.chooseImage()},onChooseAvatar({detail:e}){},chooseImage(){const e=this;uni.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success({tempFiles:a}){e.tempFile=a[0],e.avatarUrl=e.tempFile.path}})},uploadFile(){const e=this;return N([e.tempFile],!1).then((a=>(e.form.avatarId=a[0],e.tempFile=null,!0))).catch((()=>!1))},async handleSubmit(){const e=this;if(console.log("handleSubmit",e.form,e.tempFile),!0!==e.disabled)if(void 0===e.tempFile||S(e.form.nickName))e.$toast("请填写头像和昵称~");else{if(e.disabled=!0,!(await e.uploadFile()))return e.$toast("很抱歉，头像上传失败"),void(e.disabled=!1);e.onAuthSuccess({nickName:e.form.nickName,avatarId:e.form.avatarId})}},handleLogin(){this.onAuthSuccess({})},async onAuthSuccess(a){const t=this;e.dispatch("LoginMpWx",{partyData:{code:await t.getCode(),oauth:"MP-WEIXIN",userInfo:a}}).then((e=>{t.$toast(e.message),uni.$emit("syncRefresh",!0),setTimeout((()=>t.onNavigateBack()),2e3)})).catch((e=>{e.result.data.isBindMobile&&t.onEmitSuccess(a)}))},async onEmitSuccess(e){this.$emit("success",{oauth:"MP-WEIXIN",code:await this.getCode(),userInfo:e})},handleCancel(){this.onNavigateBack()},onNavigateBack(e=1){a().length>1?uni.navigateBack({delta:Number(e||1)}):this.$navTo("pages/index/index")}}},[["render",function(e,a,u,p,g,y){const M=c,v=d,k=f("avatar-image"),I=r,S=h,C=n;return t(),s(v,{class:"container"},{default:i((()=>[!0===g.isPersonal?(t(),s(v,{key:0,class:"personal"},{default:i((()=>[o(v,{class:"header"},{default:i((()=>[o(v,{class:"title"},{default:i((()=>[o(M,null,{default:i((()=>[l("获取您的昵称、头像")])),_:1})])),_:1}),o(v,{class:"sub-title"},{default:i((()=>[o(M,null,{default:i((()=>[l("填写您的微信头像和昵称，以便获得更好的体验")])),_:1})])),_:1})])),_:1}),o(v,{class:"login-form"},{default:i((()=>[o(v,{class:"form-item"},{default:i((()=>[o(v,{class:"form-item--label"},{default:i((()=>[l("头像")])),_:1}),o(I,{class:"btn-normal","open-type":"chooseAvatar",onClick:a[0]||(a[0]=e=>y.onClickAvatar()),onChooseavatar:y.onChooseAvatar},{default:i((()=>[o(k,{url:g.avatarUrl,width:100},null,8,["url"])])),_:1},8,["onChooseavatar"])])),_:1}),o(v,{class:"form-item"},{default:i((()=>[o(v,{class:"form-item--label"},{default:i((()=>[l("昵称")])),_:1}),o(S,{class:"form-item--input",type:"nickname",modelValue:g.form.nickName,"onUpdate:modelValue":a[1]||(a[1]=e=>g.form.nickName=e),maxlength:"30",placeholder:"请输入微信昵称",onInput:y.onInputNickName,onBlur:y.onInputNickName},null,8,["modelValue","onInput","onBlur"])])),_:1})])),_:1}),o(v,{class:"login-btn"},{default:i((()=>[o(v,{class:m(["button",{disabled:g.disabled}]),onClick:a[2]||(a[2]=e=>y.handleSubmit())},{default:i((()=>[l("确认")])),_:1},8,["class"])])),_:1}),o(v,{class:"no-login-btn"},{default:i((()=>[o(v,{class:"button",onClick:a[3]||(a[3]=e=>y.handleCancel())},{default:i((()=>[l("暂不登录")])),_:1})])),_:1})])),_:1})):b("",!0),!1===g.isPersonal?(t(),s(v,{key:1,class:"authorize"},{default:i((()=>[o(v,{class:"store-info"},{default:i((()=>[o(v,{class:"header"},{default:i((()=>[o(C,{class:"image",src:g.storeInfo&&g.storeInfo.image_url?g.storeInfo.image_url:"/static/default-logo.png"},null,8,["src"])])),_:1})])),_:1}),o(v,{class:"auth-title"},{default:i((()=>[l("申请获取以下权限")])),_:1}),o(v,{class:"auth-subtitle"},{default:i((()=>[l("获得你的公开信息（昵称、头像等）")])),_:1}),o(v,{class:"login-btn"},{default:i((()=>[o(v,{class:m(["button",{disabled:g.disabled}]),onClick:a[4]||(a[4]=e=>y.handleLogin())},{default:i((()=>[l("一键登录")])),_:1},8,["class"])])),_:1}),o(v,{class:"no-login-btn"},{default:i((()=>[o(v,{class:"button",onClick:a[5]||(a[5]=e=>y.handleCancel())},{default:i((()=>[l("暂不登录")])),_:1})])),_:1})])),_:1})):b("",!0)])),_:1})}],["__scopeId","data-v-26ae0bad"]])},data:()=>({isLoad:!1,setting:{},isMpWeixinAuth:!1,isMpWeixinMobile:!1,isParty:!1,partyData:{}}),async onLoad(e){await this.getRegisterSetting(),await this.setShowUserInfo(),this.isLoad=!0},methods:{async getRegisterSetting(){this.setting=await y.item(M.REGISTER.value,!1)},async setShowUserInfo(){const e=this,a="MP-WEIXIN"===e.platform;e.isMpWeixinAuth=a&&Boolean(e.setting.isOauthMpweixin),e.isMpWeixinMobile=a&&Boolean(e.setting.isOauthMobileMpweixin)},onGetUserInfoSuccess(e){this.partyData=e,this.onShowRegister()},onShowRegister(){"MP-WEIXIN"===this.partyData.oauth&&(this.isMpWeixinAuth=!1),this.isParty=!0}}},[["render",function(e,a,o,l,n,c){const r=f("MpWeixin"),u=f("Main"),m=d;return n.isLoad?(t(),s(m,{key:0,class:"login",style:v(e.appThemeStyle)},{default:i((()=>[n.isMpWeixinAuth?(t(),s(r,{key:0,onSuccess:c.onGetUserInfoSuccess},null,8,["onSuccess"])):(t(),s(u,{key:1,isParty:n.isParty,partyData:n.partyData,isMpWeixinMobile:n.isMpWeixinMobile},null,8,["isParty","partyData","isMpWeixinMobile"]))])),_:1},8,["style"])):b("",!0)}]]);export{B as default};
